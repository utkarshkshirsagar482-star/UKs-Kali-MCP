from mcp.server.fastmcp import FastMCP
import subprocess
import asyncio
import shlex

# Initialize FastMCP server
mcp = FastMCP("PentestTools")

@mcp.tool()
async def execute_command(command: str) -> str:
    """
    Executes a shell command on the system.
    WARNING: Use with caution. This allows arbitrary command execution.
    """
    try:
        # Split command for safety, but we are running in shell=True to support pipes/redirection if needed
        # However, for security, using list is better, but user asked for "all tools", so shell might be needed.
        # We will use shell=True to allow flexibility (e.g., nmap -sV ... | grep ...)
        # In a real secure environment, this is bad practice.
        proc = await asyncio.create_subprocess_shell(
            command,
            stdout=asyncio.subprocess.PIPE,
            stderr=asyncio.subprocess.PIPE
        )

        try:
            stdout_data, stderr_data = await asyncio.wait_for(proc.communicate(), timeout=60)
        except asyncio.TimeoutError:
            try:
                proc.kill()
            except ProcessLookupError:
                pass
            await proc.communicate()
            return "Command timed out."

        stdout = stdout_data.decode()
        stderr = stderr_data.decode()

        if proc.returncode != 0:
            return f"Error executing command: {stderr}"

        return stdout
    except Exception as e:
        return f"Unexpected error: {str(e)}"

@mcp.tool()
def run_python_script(script_content: str) -> str:
    """
    Executes a python script provided as a string.
    """
    try:
        result = subprocess.run(
            ["python3", "-c", script_content],
            capture_output=True,
            text=True,
            timeout=30
        )
        if result.returncode == 0:
            return result.stdout
        else:
            return f"Error: {result.stderr}"
    except Exception as e:
        return f"Execution failed: {str(e)}"

@mcp.tool()
def nmap_scan(target: str, arguments: str = "-F") -> str:
    """
    Runs an Nmap scan against a target.
    Default arguments: -F (Fast scan)
    """
    # Sanitize input slightly to prevent easy chaining if we weren't using shell=False (but subprocess handles list well)
    cmd = ["nmap"] + shlex.split(arguments) + [target]
    try:
        result = subprocess.run(
            cmd,
            capture_output=True,
            text=True,
            timeout=120
        )
        return result.stdout
    except Exception as e:
        return f"Nmap scan failed: {str(e)}"

if __name__ == "__main__":
    mcp.run()
