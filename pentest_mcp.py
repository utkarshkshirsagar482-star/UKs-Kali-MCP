from mcp.server.fastmcp import FastMCP
import subprocess
import shlex
import asyncio

# Initialize FastMCP server
mcp = FastMCP("PentestTools")

@mcp.tool()
def execute_command(command: str) -> str:
    """
    Executes a shell command on the system.
    WARNING: Use with caution. This allows arbitrary command execution.
    """
    try:
        # Split command for safety, but we are running in shell=True to support pipes/redirection if needed
        # However, for security, using list is better, but user asked for "all tools", so shell might be needed.
        # We will use shell=True to allow flexibility (e.g., nmap -sV ... | grep ...)
        # In a real secure environment, this is bad practice.
        result = subprocess.run(
            command,
            shell=True,
            check=True,
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
            text=True,
            timeout=60 # 1 minute timeout
        )
        return result.stdout
    except subprocess.CalledProcessError as e:
        return f"Error executing command: {e.stderr}"
    except subprocess.TimeoutExpired:
        return "Command timed out."
    except Exception as e:
        return f"Unexpected error: {str(e)}"

@mcp.tool()
async def run_python_script(script_content: str) -> str:
    """
    Executes a python script provided as a string.
    """
    try:
        process = await asyncio.create_subprocess_exec(
            "python3", "-c", script_content,
            stdout=asyncio.subprocess.PIPE,
            stderr=asyncio.subprocess.PIPE
        )

        try:
            stdout, stderr = await asyncio.wait_for(process.communicate(), timeout=30)
        except asyncio.TimeoutError:
            process.kill()
            await process.communicate()
            return "Execution failed: Command timed out."

        if process.returncode == 0:
            return stdout.decode()
        else:
            return f"Error: {stderr.decode()}"
    except Exception as e:
        return f"Execution failed: {str(e)}"

@mcp.tool()
def nmap_scan(target: str, arguments: str = "-F") -> str:
    """
    Runs an Nmap scan against a target.
    Default arguments: -F (Fast scan)
    """
    # Sanitize input slightly to prevent easy chaining if we weren't using shell=False (but subprocess handles list well)
    cmd = ["nmap"] + shlex.split(arguments) + [target]
    try:
        result = subprocess.run(
            cmd,
            capture_output=True,
            text=True,
            timeout=120
        )
        return result.stdout
    except Exception as e:
        return f"Nmap scan failed: {str(e)}"

if __name__ == "__main__":
    mcp.run()
